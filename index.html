<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Slot Machine - BNZ Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            color: white;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            border: 8px solid #4e4e4e;
            background: #2d2d2d;
            padding: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5), inset 0 0 20px #000;
        }

        .header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            font-size: 10px;
        }

        #slot-canvas {
            image-rendering: pixelated;
            background: #000;
            border: 4px solid #ffd700;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        button {
            background: #e63946;
            border: none;
            border-bottom: 6px solid #b91d2c;
            color: white;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            transition: all 0.1s;
        }

        button:active {
            border-bottom: 2px solid #b91d2c;
            transform: translateY(4px);
        }

        button:disabled {
            background: #555;
            border-bottom: 6px solid #333;
            cursor: not-allowed;
        }

        .stats {
            text-align: center;
            margin-top: 10px;
            color: #ffd700;
        }

        #message-banner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            text-align: center;
            display: none;
            border: 4px solid #fff;
            z-index: 10;
            pointer-events: none;
        }

        .shake { animation: shake 0.2s infinite; }
        @keyframes shake {
            0% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, -2px); }
            100% { transform: translate(2px, -2px); }
        }
    </style>
</head>
<body>

    <div class="header" style="width: 500px;">
        <div>CHIPS: <span id="chips-count">100</span></div>
        <div>HI-SCORE: <span id="high-score">0</span></div>
    </div>

    <div id="game-container">
        <div id="message-banner">JACKPOT !</div>
        <canvas id="slot-canvas" width="400" height="200"></canvas>
        
        <div class="controls">
            <button id="spin-btn">SPIN!</button>
            <div class="stats">COST: 10</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('slot-canvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spin-btn');
        const chipsDisplay = document.getElementById('chips-count');
        const highscoreDisplay = document.getElementById('high-score');
        const banner = document.getElementById('message-banner');

        // Game State
        let chips = 100;
        let highscore = localStorage.getItem('slotHiScore') || 0;
        highscoreDisplay.textContent = highscore;
        
        const symbols = ['üçí', 'üçã', 'üçá', 'üîî', '7', 'B', 'N', 'Z'];
        const weights = [0.2, 0.2, 0.15, 0.15, 0.1, 0.06, 0.06, 0.08]; // Probabilit√©s
        
        let reels = [
            { y: 0, targets: [0, 1, 2], spinning: false, speed: 0 },
            { y: 0, targets: [1, 2, 3], spinning: false, speed: 0 },
            { y: 0, targets: [2, 3, 4], spinning: false, speed: 0 }
        ];

        // --- AUDIO SYSTEM (Procedural) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(freq, type, duration, vol=0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playCasinoAmbience() {
            // Un petit bruit blanc filtr√© pour simuler la foule
            setInterval(() => {
                if(Math.random() > 0.98) playSound(200 + Math.random() * 500, 'sine', 0.5, 0.02);
            }, 100);
        }
        playCasinoAmbience();

        // --- DRAWING ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const slotWidth = canvas.width / 3;
            const slotHeight = canvas.height;

            reels.forEach((reel, i) => {
                ctx.save();
                ctx.translate(i * slotWidth, 0);
                
                // Dessin du fond de la bobine
                ctx.fillStyle = '#111';
                ctx.fillRect(5, 5, slotWidth - 10, slotHeight - 10);
                
                // Dessin des symboles
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                
                for (let j = -1; j < 4; j++) {
                    const symbolIdx = (Math.floor(reel.y / 60) + j + symbols.length) % symbols.length;
                    const symbol = symbols[symbolIdx];
                    const yPos = (j * 70) + (reel.y % 70);
                    
                    // Effet de flou de mouvement
                    ctx.globalAlpha = reel.spinning ? 0.5 : 1.0;
                    ctx.fillText(symbol, slotWidth / 2, yPos + 60);
                }
                ctx.restore();
            });

            // Overlay de la machine (vitre et reflets)
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            requestAnimationFrame(draw);
        }

        // --- LOGIC ---
        function spin() {
            if (chips < 10 || reels.some(r => r.spinning)) return;

            // D√©duction jetons
            chips -= 10;
            updateUI();
            playSound(150, 'square', 0.1);
            
            reels.forEach((reel, i) => {
                reel.spinning = true;
                reel.speed = 20 + Math.random() * 10;
                
                setTimeout(() => {
                    stopReel(i);
                }, 1000 + i * 600);
            });
        }

        function stopReel(i) {
            const stopInterval = setInterval(() => {
                reels[i].speed *= 0.9;
                reels[i].y += reels[i].speed;

                if (reels[i].speed < 2) {
                    reels[i].speed = 0;
                    reels[i].spinning = false;
                    reels[i].y = Math.round(reels[i].y / 70) * 70; // Alignement propre
                    clearInterval(stopInterval);
                    playSound(100, 'sawtooth', 0.1);
                    
                    if (i === 2) checkWin();
                } else {
                    reels[i].y += reels[i].speed;
                }
            }, 20);
        }

        function checkWin() {
            // Calcul des symboles finaux (ceux au centre)
            const results = reels.map(r => {
                const idx = (Math.floor(r.y / 70) + 1) % symbols.length;
                return symbols[idx < 0 ? symbols.length + idx : idx];
            });

            let winAmount = 0;
            let msg = "";

            // Condition JACKPOT : B N Z
            if (results[0] === 'B' && results[1] === 'N' && results[2] === 'Z') {
                winAmount = 500;
                msg = "JACKPOT BNZ !!!";
                celebrate();
            } 
            // 3 symboles identiques
            else if (results[0] === results[1] && results[1] === results[2]) {
                const sym = results[0];
                if (sym === '7') winAmount = 100;
                else if (sym === 'üîî') winAmount = 50;
                else winAmount = 30;
                msg = "TRIPLE " + sym + " !";
                playSound(600, 'sine', 0.5);
            }
            // 2 symboles identiques au d√©but
            else if (results[0] === results[1]) {
                winAmount = 15;
                msg = "PETIT BONUS !";
            }

            if (winAmount > 0) {
                chips += winAmount;
                showBanner(msg);
                if (chips > highscore) {
                    highscore = chips;
                    localStorage.setItem('slotHiScore', highscore);
                }
            }

            updateUI();
            
            if (chips < 10) {
                setTimeout(() => {
                    alert("GAME OVER! Red√©marrage...");
                    chips = 100;
                    updateUI();
                }, 1000);
            }
        }

        function celebrate() {
            document.body.classList.add('shake');
            for(let i=0; i<10; i++) {
                setTimeout(() => playSound(400 + i*100, 'square', 0.2), i*100);
            }
            setTimeout(() => document.body.classList.remove('shake'), 2000);
        }

        function showBanner(text) {
            banner.textContent = text;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 2000);
        }

        function updateUI() {
            chipsDisplay.textContent = chips;
            highscoreDisplay.textContent = highscore;
            spinBtn.disabled = chips < 10;
        }

        spinBtn.addEventListener('click', () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            spin();
        });

        draw();
    </script>
</body>
</html>
