<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino BNZ - John Pork Underground</title>
    <style>
        :root {
            --gold: #d4af37;
            --red: #8b0000;
            --dark: #0a0a0a;
            --pork-pink: #ffafcc;
            --emoji-font: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }

        body {
            background: var(--dark);
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* --- √âCRAN D'ACCUEIL --- */
        #setup-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 15px solid var(--red);
            text-align: center;
        }

        .btn-enter {
            background: var(--red);
            border: 3px solid var(--gold);
            padding: 25px 60px;
            color: var(--gold);
            font-size: 2rem;
            font-weight: 900;
            cursor: pointer;
            border-radius: 15px;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .btn-enter:hover {
            background: var(--gold);
            color: var(--red);
            transform: scale(1.1);
        }

        /* --- INTERFACE PRINCIPALE --- */
        .header {
            width: 100%;
            padding: 15px 40px;
            background: linear-gradient(to bottom, #222, #000);
            border-bottom: 3px solid var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .casino-unit {
            margin-top: 60px;
            padding: 30px;
            background: var(--red);
            border: 12px solid var(--gold);
            border-radius: 25px;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2), inset 0 0 30px #000;
            position: relative;
        }

        .reels-view {
            display: flex;
            gap: 15px;
            background: #000;
            padding: 20px;
            border: 6px solid #111;
            height: 140px;
            overflow: hidden;
            border-radius: 10px;
        }

        .reel-track {
            width: 110px;
            display: flex;
            flex-direction: column;
            will-change: transform;
        }

        .symbol {
            width: 110px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4.5rem;
            flex-shrink: 0;
            font-family: var(--emoji-font);
        }

        .sym-B, .sym-N, .sym-Z {
            font-family: 'Arial Black', sans-serif;
            font-weight: 900;
            color: #fff;
        }
        .sym-B { background: radial-gradient(circle, #1e3a8a, #000); }
        .sym-N { background: radial-gradient(circle, #991b1b, #000); }
        .sym-Z { background: radial-gradient(circle, #065f46, #000); }

        .spin-btn {
            margin-top: 40px;
            padding: 25px 100px;
            background: linear-gradient(to bottom, #fde047, var(--gold));
            color: #000;
            font-size: 2rem;
            font-weight: 900;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 8px 0 #8a6d0d;
            transition: 0.1s;
            text-transform: uppercase;
        }

        .spin-btn:active { transform: translateY(4px); box-shadow: 0 4px 0 #8a6d0d; }
        .spin-btn:disabled { background: #444; color: #777; box-shadow: none; cursor: not-allowed; }

        /* --- MODALE --- */
        #pork-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .countdown {
            font-size: 12rem;
            color: var(--gold);
            font-weight: 900;
            text-shadow: 0 0 30px var(--gold);
        }

        #pork-body {
            text-align: center;
            max-width: 700px;
            width: 90%;
        }

        .pork-avatar {
            font-size: 100px;
            margin-bottom: 20px;
            font-family: var(--emoji-font);
            animation: shake 0.1s infinite;
        }

        .pork-speech {
            background: #fff;
            color: #000;
            padding: 35px;
            border-left: 15px solid var(--gold);
            border-radius: 0 30px 30px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .gage-name { font-size: 2rem; margin: 0 0 15px 0; color: var(--red); text-transform: uppercase; }
        .gage-rule { font-size: 1.4rem; line-height: 1.5; color: #111; font-weight: 600; }

        .btn-action {
            margin-top: 15px;
            padding: 12px 25px;
            background: #222;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-done {
            margin-top: 40px;
            padding: 20px 50px;
            background: var(--gold);
            border: none;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50px;
        }

        /* --- MINI JEUX --- */
        #reaction-game {
            display: none;
            width: 100%;
            height: 250px;
            background: #f0f0f0;
            position: relative;
            cursor: crosshair;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 15px;
            border: 4px solid #ddd;
        }

        #pmu-game {
            display: none;
            width: 100%;
            background: #1b4d1b;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            box-sizing: border-box;
        }

        .horse-track {
            height: 45px;
            border-bottom: 2px dashed rgba(255,255,255,0.3);
            position: relative;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .horse {
            position: absolute;
            left: 0;
            font-size: 30px;
            transition: left 0.1s linear;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- DEBUG PANEL --- */
        #debug-panel {
            position: fixed;
            right: -320px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            border-left: 2px solid var(--gold);
            z-index: 3000;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #debug-panel.open { right: 0; }
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: #666;
            border: none;
            padding: 5px;
            font-size: 0.6rem;
            cursor: pointer;
            z-index: 3001;
        }
        .debug-section-title { color: var(--gold); font-weight: bold; margin: 15px 0 5px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .debug-btn {
            background: #111;
            color: #eee;
            border: 1px solid #222;
            padding: 6px;
            text-align: left;
            margin-bottom: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .debug-btn:hover { background: var(--red); }

        @keyframes shake {
            0% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, -2px); }
            100% { transform: translate(2px, -2px); }
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="color:var(--gold); font-size: 4rem; margin-bottom: 10px;">CASINO BNZ</h1>
        <p style="font-size: 1.5rem; color: #aaa; margin-bottom: 40px;">L'antre de John Pork</p>
        <button class="btn-enter" onclick="initGame()">Entrer dans le casino</button>
    </div>

    <div class="header">
        <div class="logo">Casino <span style="color:var(--gold)">BNZ</span></div>
        <div style="color:var(--gold); font-weight: bold;">John Pork vous surveille</div>
    </div>

    <div class="casino-unit">
        <div class="reels-view">
            <div class="reel-track" id="r0"><div class="symbol">üé∞</div></div>
            <div class="reel-track" id="r1"><div class="symbol">üé∞</div></div>
            <div class="reel-track" id="r2"><div class="symbol">üé∞</div></div>
        </div>
    </div>

    <button id="spin-btn" class="spin-btn" onclick="play()">Lancer le destin</button>

    <button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>
    <div id="debug-panel">
        <h2 style="color:white; font-size: 1.2rem;">TEST GAGES</h2>
        <div id="debug-content"></div>
    </div>

    <div id="pork-modal">
        <div id="pork-timer" class="countdown">3</div>
        <div id="pork-body" style="display:none;">
            <div class="pork-avatar">üê∑</div>
            <div class="pork-speech">
                <h2 id="gage-title" class="gage-name"></h2>
                
                <div id="gage-content">
                    <div id="gage-desc" class="gage-rule"></div>
                    <div id="gage-extra" style="margin-top:10px;"></div>
                </div>

                <div id="reaction-game" onclick="handleReactionClick()">
                    <div id="target-pig" style="display:none; position:absolute; font-size:60px; cursor:pointer;">üê∑</div>
                    <div id="reaction-message" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#666; font-weight:bold; font-size:1.5rem;">ATTENDS LE SIGNAL...</div>
                </div>

                <div id="pmu-game">
                    <div class="horse-track"><div class="horse" id="h1" style="background:#ff4d4d; border-radius:50%">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h2" style="background:#4d79ff; border-radius:50%">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h3" style="background:#ffff4d; border-radius:50%">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h4" style="background:#ff4dff; border-radius:50%">üèá</div></div>
                    <button id="start-pmu-btn" class="btn-action" style="width:100%" onclick="runPMU()">LANCER LA COURSE !</button>
                </div>

                <p id="pork-footer" style="margin-top:25px; color:#666; font-style:italic; border-top:1px solid #eee; padding-top:15px; font-size:0.8rem;">
                    John Pork : "Allez, bois ton venin et rejoue !"
                </p>
            </div>
            <button id="close-modal-btn" class="btn-done" onclick="closePork()">C'EST FAIT, JE REJOUE</button>
        </div>
    </div>

<script>
    const QUESTIONS = [
        { q: "Qui a √©t√© la premi√®re femme √† recevoir un prix Nobel en 1903 ?", r: "Marie Curie" },
        { q: "En quelle ann√©e le mur de Berlin est-il tomb√© ?", r: "1989" },
        { q: "Quel est l'√©l√©ment dont le symbole chimique est Au ?", r: "L'or" },
        { q: "Quel est le signe oppos√© au Scorpion dans le zodiaque ?", r: "Le Taureau" },
        { q: "Qui a √©crit le roman am√©ricain classique 'Their Eyes Were Watching God' ?", r: "Zora Neale Hurston" },
        { q: "Qui a tir√© le coup de feu en 1914 qui a d√©clench√© la Premi√®re Guerre mondiale ?", r: "L'archiduc Fran√ßois-Ferdinand (par Gavrilo Princip)" },
        { q: "Quelle est la plus petite plan√®te de notre syst√®me solaire ?", r: "Mercure" },
        { q: "Quel est le spectacle de Broadway le plus lucratif de tous les temps ?", r: "Le Roi Lion" },
        { q: "Comment s'appellent les 22 premi√®res cartes d'un jeu de tarot ?", r: "Les Arcanes Majeurs" },
        { q: "Quelle est la capitale de l'Inde ?", r: "New Delhi" },
        { q: "Sous quel nom la viande de cerf appara√Æt-elle sur le menu ?", r: "Le chevreuil" },
        { q: "Quel est le plus grand organe du corps humain ?", r: "La peau" },
        { q: "En quelle ann√©e le premier iPhone a-t-il √©t√© commercialis√© ?", r: "2007" },
        { q: "Quels sont les pr√©noms des quatre personnages de 'H' ?", r: "Jamel, Brahim, Aym√© et Kader" },
        { q: "Combien d'os les requins ont-ils ?", r: "Z√©ro !" },
        { q: "Quel est l'animal le plus mortel au monde ?", r: "Le moustique" },
        { q: "Dans quel pays est n√© Che Guevara ?", r: "L'Argentine" },
        { q: "Quelle c√©l√©brit√© a inspir√© le nom du premier mouton clon√© (Dolly) ?", r: "Dolly Parton" },
        { q: "Quel est le fleuve qui traverse Paris ?", r: "La Seine" },
        { q: "Combien de couleurs dans un sachet de M&Ms ?", r: "Six" },
        { q: "Quel pays a offert la statue de la Libert√© aux USA ?", r: "La France" },
        { q: "Quelle boisson alcoolis√©e est fabriqu√©e √† partir de baies de gen√©vrier ?", r: "Le gin" },
        { q: "O√π se trouve le plus petit os du corps humain ?", r: "L'oreille" },
        { q: "Quelle est la capitale du Canada ?", r: "Ottawa" },
        { q: "Qui a √©crit Les aventures de Sherlock Holmes ?", r: "Arthur Conan Doyle" },
        { q: "Quel animal sur le logo de Porsche ?", r: "Le cheval" },
        { q: "En quelle ann√©e le Titanic a-t-il coul√© ?", r: "1912" },
        { q: "Quelle est la plus grande √Æle de la M√©diterran√©e ?", r: "La Sicile" },
        { q: "Quel pays a pour capitale Singapour ?", r: "Singapour" },
        { q: "Qui d√©tient le record d'Emmy Awards comme animateur de t√©l√©r√©alit√© ?", r: "RuPaul" },
        { q: "Quelle ville a accueilli les JO d'hiver 2014 ?", r: "Sotchi" },
        { q: "Quelle est la langue la plus parl√©e au Br√©sil ?", r: "Le portugais" },
        { q: "Quel pr√©sident figure sur le billet de 2 dollars ?", r: "Thomas Jefferson" },
        { q: "Quelle est la temp√©rature d'√©bullition de l'eau ?", r: "100¬∞C" },
        { q: "Quel c√©l√®bre mouvement artistique Picasso a-t-il co-cr√©√© ?", r: "Le cubisme" },
        { q: "Qui a compos√© la 'Sonate au clair de lune' ?", r: "Beethoven" }
    ];

    const DATA = {
        pays: ["France", "USA", "Japon", "Italie", "Br√©sil", "Allemagne", "Russie", "Espagne", "Belgique", "Canada", "Mexique", "Portugal", "Su√®de", "Gr√®ce"],
        categories: ["Marques de bi√®re", "Marques de luxe", "Pr√©noms commen√ßant par A", "Rappeurs fran√ßais", "Jeux vid√©o", "S√©ries Netflix", "Films d'horreur"],
        adjectifs: ["le plus radin", "celui qui parle le plus fort", "le plus lourd", "celui qui va finir en PLS", "le plus mauvais perdant", "celui qui a le plus soif", "le plus de mauvaise foi", "le plus susceptible de finir ministre"],
        lettres: ["A", "B", "C", "D", "E", "F", "G", "H", "L", "M", "N", "P", "R", "S", "T"]
    };

    const symbols = ['üê∑', 'üêó', 'üç∫', 'üíÄ'];
    let reactionStartTime = 0;
    let reactionTimeout = null;
    let isDebugMode = false;
    let isReactionActive = false;

    // --- TEMPLATES DES GAGES ---
    const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    const DOUBLES_TEMPLATE = () => [
        { id: "REACTION", t: "ON SE BOUGE !", d: "Clique sur le porc d√®s qu'il appara√Æt ! Si tu mets plus de 0.65s, tu bois une gorg√©e." },
        { t: "LE SAVANT", d: `Cite 5 villes du pays suivant : ${rand(DATA.pays)} sans b√©gayer ou bois une gorg√©e.` },
        { t: "L'ALPHABET", d: `Cite 3 √©l√©ments de "${rand(DATA.categories)}" commen√ßant par la lettre ${rand(DATA.lettres)} ou bois une gorg√©e.` },
        { t: "SANT√â SOLO", d: "Punition directe de 3 gorg√©es pour toi l'ami." },
        { id: "FLASH", t: "FLASH CONNAISSANCE", d: "R√©ponds √† cette question ou bois une gorg√©e." },
        { t: "CIN√âMA", d: "Cite 3 films d'un m√™me r√©alisateur de ton choix ou bois une gorg√©e." },
        { t: "GASTRONOMIE", d: "Cite 3 types de fromages diff√©rents ou bois une gorg√©e." },
        { t: "G√âO/TECH/NATURE", d: "Cite 3 fleuves c√©l√®bres ou 3 plan√®tes du syst√®me solaire ou bois une gorg√©e." },
        { t: "TOP 3", d: `Cite tes 3 pires ${rand(["exs", "coups", "souvenirs de soir√©e", "vacances"])} ou bois une gorg√©e.` },
        { t: "IMITATION", d: "Imite une star ; si personne ne trouve en 20s, bois une gorg√©e." },
        { t: "C'EST QUI ?", d: `Vote collectif : Qui est ${rand(DATA.adjectifs)} ? Le plus d√©sign√© boit 5 gorg√©es.` },
        { t: "LA CIBLE", d: "D√©signe une personne du groupe qui doit boire 3 gorg√©es imm√©diatement." },
        { t: "LE DUEL", d: "Duel de Chifoumi contre ton voisin de droite. Le perdant boit 3 gorg√©es." },
        { t: "FINGERS", d: "Le dernier √† poser son doigt sur le bord de la table boit 3 gorg√©es." },
        { t: "LA CHA√éNE", d: `Th√®me circulaire : ${rand(DATA.categories)}. Le premier qui s√®che boit 4 gorg√©es.` },
        { t: "DUEL DE REGARD", d: "Contre ton voisin de gauche ; le premier qui rit ou cligne boit 4 gorg√©es." },
        { t: "RIZZ TIME", d: "Drague ton voisin de gauche, si c'est pas convaincant tu bois une gorg√©e." },
        { t: "LE COMPTE", d: "Comptez jusqu'√† 20 un par un. Si deux personnes parlent en m√™me temps, tout le monde boit 3 et on recommence." },
        { t: "JUMEAUX", d: "D√©signe deux personnes qui boiront ensemble pour les trois prochains tours." },
        { t: "TECHNO/SOCIAL", d: "La personne avec le plus de meufs dans ses dix derniers DMs Insta boit une gorg√©e." },
        { t: "HOT TAKE", d: "Donnez une opinion controvers√©e sur les BNZ, le pire fils de pute √† le droit de distribuer une gorg√©e." },
        { t: "CONNARD !", d: "Sors une phrase qu'un √©norme connard pourrait dire. Si c'est trop light tu bois." }
    ];

    const TRIPLES_TEMPLATE = () => [
        { id: "PMU", t: "PMU", d: "Chacun choisit un cheval. Les gagnants distribuent 6 gorg√©es aux autres." },
        { t: "CUL-SEC PARTIEL", d: "Bois la moiti√© de ton verre imm√©diatement. John Pork adore √ßa." },
        { t: "LE PACTE", d: "Bois 3 gorg√©es ou parie sur le prochain tour (Gagnant/Perdant). Si tu perds le pari, finis ton verre." },
        { t: "DOUBLE DOSE", d: "Tes 3 prochaines punitions (peu importe le spin) sont doubl√©es. T'es maudit." },
        { t: "LE CHOIX", d: "Soit tu bois 7 gorg√©es, soit tu montres ta derni√®re photo de t√©l√©phone au voisin." },
        { t: "LE DICTATEUR", d: "D√©signe deux personnes qui doivent finir leur verre imm√©diatement." },
        { t: "D√âCRET ROYAL", d: "Installe une r√®gle (ex: pas de pr√©noms). Chaque faute = 2 gorg√©es." },
        { t: "L'ENCH√àRE", d: "Qui est pr√™t √† boire le plus de gorg√©es ? Le gagnant sauve le groupe mais boit son annonce." },
        { t: "LA CASCADE", d: "Waterfall ! Tout le monde boit, tu d√©cides quand tu t'arr√™tes." },
        { t: "LE CAGEOT", d: "D√©signe la personne avec le moins de flow. Elle s√©duit un objet pendant 1 min ou finit son verre." },
        { t: "TRIBUNAL", d: "Le groupe vote pour celui qui doit boire 8 gorg√©es." },
        { t: "ESPRIT D'√âQUIPE", d: "Tout le monde finit son verre sauf toi. Sale tra√Ætre." },
        { t: "MA√éTRE DU JEU", d: "Distribue 10 gorg√©es comme tu veux." },
        { t: "CHOIX DE PORK", d: "Soit tu bois 10 gorg√©es, soit tout le monde en boit 3." },
        { t: "LA DERNI√àRE", d: "Tout le monde finit son verre. Sant√© !" }
    ];

    // --- LOGIQUE DEBUG ---
    function toggleDebug() {
        isDebugMode = !isDebugMode;
        document.getElementById('debug-panel').classList.toggle('open');
        if (isDebugMode) populateDebugMenu();
    }

    function populateDebugMenu() {
        const content = document.getElementById('debug-content');
        content.innerHTML = '';
        const sections = [
            { title: "JACKPOT", list: [{ t: "BNZ JACKPOT", id: "BNZ" }] },
            { title: "DOUBLES", list: DOUBLES_TEMPLATE() },
            { title: "TRIPLES", list: TRIPLES_TEMPLATE() }
        ];
        sections.forEach(section => {
            const title = document.createElement('div');
            title.className = 'debug-section-title';
            title.innerText = section.title;
            content.appendChild(title);
            section.list.forEach(gage => {
                const btn = document.createElement('div');
                btn.className = 'debug-btn';
                btn.innerText = gage.t;
                btn.onclick = () => { toggleDebug(); showGageModal(gage, section.title === "JACKPOT" ? "BNZ" : (section.title === "DOUBLES" ? "DOUBLE" : "TRIPLE")); };
                content.appendChild(btn);
            });
        });
    }

    // --- LOGIQUE JEU DE R√âACTION ---
    function startReactionGame() {
        const game = document.getElementById('reaction-game');
        const target = document.getElementById('target-pig');
        const msg = document.getElementById('reaction-message');
        game.style.display = 'block';
        target.style.display = 'none';
        msg.innerText = "ATTENDS LE SIGNAL...";
        msg.style.color = "#666";
        isReactionActive = true;
        reactionStartTime = 0;
        
        const delay = Math.random() * 5000 + 2000;
        reactionTimeout = setTimeout(() => {
            if(!isReactionActive) return;
            msg.innerText = "CLIQUE MAINTENANT !";
            msg.style.color = "#d4af37";
            target.style.display = 'block';
            target.style.top = Math.random() * 150 + 20 + 'px';
            target.style.left = Math.random() * 70 + 5 + '%';
            reactionStartTime = Date.now();
        }, delay);
    }

    function handleReactionClick() {
        if (!isReactionActive) return;
        const msg = document.getElementById('reaction-message');
        const target = document.getElementById('target-pig');
        const extra = document.getElementById('gage-extra');
        
        if (reactionStartTime === 0) {
            clearTimeout(reactionTimeout);
            msg.innerText = "TROP T√îT !";
            extra.innerHTML = "<p style='color:red; font-weight:bold;'>T'es trop press√© mon gros. BOIS 2 GORG√âES.</p>";
        } else {
            const diff = (Date.now() - reactionStartTime) / 1000;
            target.style.display = 'none';
            if (diff <= 0.65) {
                msg.innerText = "GAGN√â !";
                extra.innerHTML = `<p style='color:green; font-weight:bold;'>Temps : ${diff}s. Propre. Tu distribues 2 gorg√©es.</p>`;
            } else {
                msg.innerText = "PERDU !";
                extra.innerHTML = `<p style='color:red; font-weight:bold;'>Temps : ${diff}s. C'est trop lent ! BOIS 1 GORG√âE.</p>`;
            }
        }
        isReactionActive = false;
        document.getElementById('close-modal-btn').style.display = 'block';
    }

    // --- LOGIQUE PMU ---
    async function runPMU() {
        document.getElementById('start-pmu-btn').style.display = 'none';
        const horses = [document.getElementById('h1'), document.getElementById('h2'), document.getElementById('h3'), document.getElementById('h4')];
        let positions = [0, 0, 0, 0];
        let winner = -1;

        while(winner === -1) {
            for(let i=0; i<4; i++) {
                // Progression beaucoup plus lente et al√©atoire
                positions[i] += Math.random() * 4; 
                if (Math.random() > 0.8) positions[i] -= Math.random() * 2; // Ralentissement
                if (positions[i] < 0) positions[i] = 0;
                
                horses[i].style.left = positions[i] + '%';
                if(positions[i] >= 88) winner = i + 1;
            }
            await new Promise(r => setTimeout(r, 100));
        }
        
        const colors = ["Rouge", "Bleu", "Jaune", "Rose"];
        document.getElementById('gage-extra').innerHTML = `<p style='font-size:1.5rem; color:#d4af37; font-weight:bold;'>LE CHEVAL ${colors[winner-1]} GAGNE !</p>`;
        document.getElementById('close-modal-btn').style.display = 'block';
    }

    // --- MOTEUR SLOT ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, d, type = 'square') {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.value = f;
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    function initGame() {
        document.getElementById('setup-screen').style.display = 'none';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        beep(400, 0.2);
    }

    async function play() {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        document.getElementById('spin-btn').disabled = true;
        beep(200, 0.1);

        const luck = Math.random();
        let res = [], combo = "";

        if(luck < 0.04) { res = ['B', 'N', 'Z']; combo = "BNZ"; } 
        else if(luck < 0.15) { const s = symbols[Math.floor(Math.random()*4)]; res = [s, s, s]; combo = "TRIPLE"; } 
        else if(luck < 0.50) { 
            const s = symbols[Math.floor(Math.random()*4)];
            let s2; do { s2 = symbols[Math.floor(Math.random()*4)]; } while(s2 === s);
            res = [s, s, s2].sort(() => Math.random() - 0.5);
            combo = "DOUBLE";
        } 
        else { 
            let s1, s2, s3;
            do {
                s1 = Math.random() > 0.8 ? 'B' : symbols[Math.floor(Math.random()*4)];
                s2 = Math.random() > 0.8 ? 'N' : symbols[Math.floor(Math.random()*4)];
                s3 = Math.random() > 0.8 ? 'Z' : symbols[Math.floor(Math.random()*4)];
            } while (s1 === s2 || s2 === s3 || s1 === s3 || (s1==='B' && s2==='N' && s3==='Z'));
            res = [s1, s2, s3];
        }

        const anims = [0,1,2].map(id => animateReel(id, res[id]));
        await Promise.all(anims);
        setTimeout(() => {
            if(combo !== "") {
                const gage = combo === "BNZ" ? { t: "JACKPOT BNZ", d: "Victoire collective ! Votre √©quipe gagne 25 JETONS IRL pour l'ench√®re." } : (combo === "DOUBLE" ? rand(DOUBLES_TEMPLATE()) : rand(TRIPLES_TEMPLATE()));
                showGageModal(gage, combo);
            } else {
                document.getElementById('spin-btn').disabled = false;
            }
        }, 500);
    }

    function animateReel(id, target) {
        return new Promise(resolve => {
            const track = document.getElementById('r'+id);
            const count = 25 + (id * 7);
            track.innerHTML = '';
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                const s = (i === count - 1) ? target : symbols[Math.floor(Math.random() * 4)];
                div.innerText = s;
                div.className = `symbol ${['B','N','Z'].includes(s) ? 'sym-'+s : ''}`;
                track.appendChild(div);
            }
            track.style.transition = 'none';
            track.style.transform = 'translateY(0)';
            track.offsetHeight;
            track.style.transition = `transform ${1.8 + id*0.5}s cubic-bezier(0.1, 0, 0, 1)`;
            track.style.transform = `translateY(-${(count-1)*140}px)`;
            setTimeout(() => { beep(200 + (id*100), 0.15, 'triangle'); resolve(); }, 1800 + id*500);
        });
    }

    async function showGageModal(gage, combo) {
        document.getElementById('gage-title').innerText = combo + " : " + gage.t;
        document.getElementById('gage-desc').innerText = gage.d;
        document.getElementById('gage-extra').innerHTML = "";
        document.getElementById('reaction-game').style.display = 'none';
        document.getElementById('pmu-game').style.display = 'none';
        document.getElementById('close-modal-btn').style.display = 'block';

        document.getElementById('pork-body').style.display = 'none';
        document.getElementById('pork-timer').style.display = 'block';
        document.getElementById('pork-modal').style.display = 'flex';

        for(let i=3; i>0; i--) {
            document.getElementById('pork-timer').innerText = i;
            beep(400, 0.1, 'square');
            await new Promise(r => setTimeout(r, 700));
        }

        document.getElementById('pork-timer').style.display = 'none';
        document.getElementById('pork-body').style.display = 'block';
        beep(150, 0.4, 'sawtooth');

        if(gage.id === "FLASH") {
            const quest = rand(QUESTIONS);
            document.getElementById('gage-desc').innerText = quest.q;
            document.getElementById('gage-extra').innerHTML = `<button class="btn-action" onclick="this.innerText='${quest.r.replace(/'/g, "\\'")}'">VOIR LA R√âPONSE</button>`;
        } else if(gage.id === "REACTION") {
            document.getElementById('close-modal-btn').style.display = 'none';
            startReactionGame();
        } else if(gage.id === "PMU") {
            document.getElementById('close-modal-btn').style.display = 'none';
            document.getElementById('pmu-game').style.display = 'block';
            document.getElementById('start-pmu-btn').style.display = 'block';
            const hs = [document.getElementById('h1'), document.getElementById('h2'), document.getElementById('h3'), document.getElementById('h4')];
            hs.forEach(h => h.style.left = '0%');
        }
    }

    function closePork() {
        isReactionActive = false;
        document.getElementById('pork-modal').style.display = 'none';
        document.getElementById('spin-btn').disabled = false;
        beep(600, 0.1);
    }
</script>
</body>
</html>
