<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino BNZ - Dirty Vegas</title>
    <style>
        :root {
            --gold: #c5a059;
            --gold-glow: #ffd700;
            --red: #5e1c1c;
            --dark: #0a0a0a;
            --neon-pink: #ff0055;
            --neon-blue: #00d4ff;
            --dirty-paper: #e6dfcc;
            --emoji-font: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }

        body {
            background: var(--dark);
            background-image: 
                radial-gradient(circle at 50% 50%, transparent 70%, rgba(0,0,0,0.9) 100%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3Base-filter id='noiseFilter'%3Base-furbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            color: #ddd;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3B%3Cfilter id='noise'%3B%3CfeTurbulence type='fractalNoise' baseFrequency='0.01' numOctaves='2'/%3B%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 5000;
        }

        /* --- √âCRAN D'ACCUEIL --- */
        #setup-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 20px solid #1a1a1a;
            text-align: center;
            box-shadow: inset 0 0 150px #000;
        }

        .neon-text {
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink);
            animation: flicker 3s infinite alternate;
        }

        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; text-shadow: 0 0 5px #fff, 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink); }
            20%, 24%, 55% { opacity: 0.4; text-shadow: none; }
        }

        .btn-enter {
            background: transparent;
            border: 4px solid var(--gold);
            padding: 20px 50px;
            color: var(--gold);
            font-size: 1.8rem;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s ease;
            margin-top: 20px;
        }

        .btn-enter:hover { background: var(--gold); color: #000; box-shadow: 0 0 40px var(--gold-glow); transform: scale(1.05); }

        /* --- INTERFACE PRINCIPALE --- */
        .header {
            width: 100%;
            padding: 15px 40px;
            background: #000;
            border-bottom: 2px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .logo { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 5px; color: var(--neon-blue); text-shadow: 0 0 8px var(--neon-blue); }

        .casino-unit {
            margin-top: 40px;
            padding: 30px;
            background: #222;
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), linear-gradient(-45deg, #2a2a2a 25%, transparent 25%);
            background-size: 4px 4px;
            border: 10px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9), inset 0 0 30px #000;
            position: relative;
        }

        .stain { position: absolute; background: rgba(80, 50, 20, 0.15); border-radius: 50%; filter: blur(15px); pointer-events: none; }

        .reels-view { display: flex; gap: 12px; background: #020202; padding: 20px; border: 5px solid #111; height: 140px; overflow: hidden; }

        .reel-track { 
            width: 100px; 
            display: flex; 
            flex-direction: column; 
            will-change: transform;
            height: auto;
        }

        .symbol { width: 100px; height: 140px; display: flex; align-items: center; justify-content: center; font-size: 4rem; flex-shrink: 0; font-family: var(--emoji-font); filter: sepia(0.4) brightness(0.9); }

        .sym-B, .sym-N, .sym-Z { font-family: 'Arial Black', sans-serif; font-weight: 900; color: #aaa; }
        .sym-B { background: #051020; border: 1px solid #1e3a8a; }
        .sym-N { background: #200505; border: 1px solid #991b1b; }
        .sym-Z { background: #052010; border: 1px solid #065f46; }

        .spin-btn {
            margin-top: 40px;
            padding: 20px 90px;
            background: #2a2a2a;
            color: var(--gold);
            font-size: 2rem;
            font-weight: 900;
            border: 4px solid var(--gold);
            cursor: pointer;
            box-shadow: 6px 6px 0px #000;
            transition: 0.1s;
            text-transform: uppercase;
        }

        .spin-btn:hover { color: #fff; box-shadow: 8px 8px 0px #000, 0 0 20px rgba(197, 160, 89, 0.3); transform: translate(-2px, -2px); }
        .spin-btn:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px #000; }

        /* --- MODALE --- */
        #pork-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .countdown { font-size: 12rem; color: #333; font-weight: 900; font-family: 'Impact', sans-serif; }
        .pork-speech { background: var(--dirty-paper); color: #1a1a1a; padding: 40px; border: 3px solid #666; box-shadow: 15px 15px 0px #000; min-height: 280px; position: relative; max-width: 750px; width: 90%; }
        .gage-name { font-family: 'Impact', sans-serif; font-size: 1.8rem; color: #000; text-transform: uppercase; border-bottom: 3px double #000; padding-bottom: 8px; margin-bottom: 15px; }
        .gage-rule { font-size: 1.4rem; line-height: 1.3; color: #222; font-weight: bold; }
        .btn-action { margin-top: 20px; padding: 12px 25px; background: #000; color: #fff; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-done { margin-top: 40px; padding: 18px 50px; background: var(--gold); color: #000; border: 3px solid #000; font-size: 1.4rem; font-weight: 900; cursor: pointer; box-shadow: 8px 8px 0px #000; transition: 0.2s; }
        .btn-done:hover { transform: translate(-2px, -2px); box-shadow: 10px 10px 0px #000; }

        /* --- MINI JEUX --- */
        #reaction-game { display: none; width: 100%; height: 220px; background: #bbb; position: relative; border: 3px solid #444; margin-top: 15px; overflow: hidden; }
        #pmu-game { display: none; width: 100%; background: #0f2b0f; padding: 20px; margin-top: 15px; border: 4px inset #000; box-sizing: border-box; }
        .horse-track { height: 45px; border-bottom: 2px dashed rgba(255,255,255,0.15); position: relative; display: flex; align-items: center; }
        .horse { position: absolute; left: 0; font-size: 32px; transition: left 0.15s linear; z-index: 2; }
        .finish-line { position: absolute; right: 10%; top: 0; bottom: 0; width: 4px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); opacity: 0.5; }

        /* --- DEBUG PANEL --- */
        #debug-panel { position: fixed; right: -320px; top: 0; width: 300px; height: 100vh; background: #050505; border-left: 2px solid var(--gold); z-index: 3000; transition: 0.3s; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #debug-panel.open { right: 0; }
        .debug-toggle { position: fixed; bottom: 5px; left: 5px; background: transparent; color: #222; border: none; font-size: 0.5rem; cursor: pointer; z-index: 3001; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 class="neon-text" style="font-size: 4rem; margin-bottom: 5px; font-family: 'Impact', sans-serif;">CASINO BNZ</h1>
        <p style="font-size: 1.4rem; color: #444; margin-bottom: 30px; font-style: italic; letter-spacing: 2px;">"Dirty Vegas Basement"</p>
        <button class="btn-enter" onclick="initGame()">Entrer dans le tripot</button>
    </div>

    <div class="header">
        <div class="logo">Tripot <span style="color:var(--neon-pink)">BNZ</span></div>
        <div style="color:#444; font-size: 0.7rem; font-family: monospace;">[SERVER_STATUS: DIRTY]</div>
    </div>

    <div class="casino-unit">
        <div class="stain" style="width:100px; height:80px; top:-20px; left:40px;"></div>
        <div class="reels-view">
            <div class="reel-track" id="r0"></div>
            <div class="reel-track" id="r1"></div>
            <div class="reel-track" id="r2"></div>
        </div>
    </div>

    <button id="spin-btn" class="spin-btn" onclick="play()">Actionner</button>

    <button class="debug-toggle" onclick="toggleDebug()">[ADMIN_DUMP]</button>
    <div id="debug-panel">
        <h2 style="color:var(--gold); font-size: 1rem; border-bottom: 1px solid #333;">DEBUG_LOGS.SYS</h2>
        <div id="debug-content"></div>
    </div>

    <div id="pork-modal">
        <div id="pork-timer" class="countdown">3</div>
        <div id="pork-body" style="display:none;">
            <div class="pork-avatar" style="animation: shake 0.2s infinite">üê∑</div>
            <div class="pork-speech">
                <h2 id="gage-title" class="gage-name"></h2>
                
                <div id="gage-content">
                    <div id="gage-desc" class="gage-rule"></div>
                    <div id="gage-extra" style="margin-top:15px;"></div>
                </div>

                <div id="reaction-game" onclick="handleReactionClick()">
                    <div id="target-pig" style="display:none; position:absolute; font-size:55px; cursor:pointer;">üê∑</div>
                    <div id="reaction-message" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#555; font-weight:900; font-size:1.8rem; text-transform:uppercase;">Ne bouge pas...</div>
                </div>

                <div id="pmu-game">
                    <div class="finish-line"></div>
                    <div class="horse-track"><div class="horse" id="h1" style="filter: drop-shadow(0 0 5px red)">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h2" style="filter: drop-shadow(0 0 5px blue)">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h3" style="filter: drop-shadow(0 0 5px yellow)">üèá</div></div>
                    <div class="horse-track"><div class="horse" id="h4" style="filter: drop-shadow(0 0 5px purple)">üèá</div></div>
                    <button id="start-pmu-btn" class="btn-action" style="width:100%; margin-top:20px; font-size:1.2rem;" onclick="runPMU()">START RACE</button>
                </div>

                <p id="pork-footer" style="margin-top:25px; color:#666; font-style:italic; border-top:1px dashed #999; padding-top:15px; font-size:0.75rem; text-align: left;">
                    [D√âCRYPTAGE] John Pork : "T'es une d√©ception humaine."
                </p>
            </div>
            <button id="close-modal-btn" class="btn-done" onclick="closePork()">D√âGAGE</button>
        </div>
    </div>

<script>
    const QUESTIONS = [
        { q: "Qui a √©t√© la premi√®re femme √† recevoir un prix Nobel en 1903 ?", r: "Marie Curie" },
        { q: "En quelle ann√©e le mur de Berlin est-il tomb√© ?", r: "1989" },
        { q: "Quel est l'√©l√©ment dont le symbole chimique est Au ?", r: "L'or" },
        { q: "Quel est le signe oppos√© au Scorpion dans le zodiaque ?", r: "Le Taureau" },
        { q: "Qui a tu√© l'archiduc Fran√ßois-Ferdinand en 1914 ?", r: "Gavrilo Princip" },
        { q: "Quelle est la plus petite plan√®te du syst√®me solaire ?", r: "Mercure" },
        { q: "Quel spectacle de Broadway est le plus lucratif de tous les temps ?", r: "Le Roi Lion" },
        { q: "Comment s'appellent les 22 premi√®res cartes d'un jeu de tarot ?", r: "Les Arcanes Majeurs" },
        { q: "Quelle est la capitale de l'Inde ?", r: "New Delhi" },
        { q: "Sous quel nom la viande de cerf appara√Æt-elle sur le menu ?", r: "Le chevreuil" },
        { q: "Quel est le plus grand organe du corps humain ?", r: "La peau" },
        { q: "En quelle ann√©e le premier iPhone a-t-il √©t√© commercialis√© ?", r: "2007" },
        { q: "Quels sont les pr√©noms des quatre personnages de 'H' ?", r: "Jamel, Brahim, Aym√© et Kader" },
        { q: "Combien d'os les requins ont-ils ?", r: "Z√©ro" },
        { q: "Quel est l'animal le plus mortel au monde ?", r: "Le moustique" },
        { q: "Dans quel pays est n√© Che Guevara ?", r: "L'Argentine" },
        { q: "Quelle c√©l√©brit√© a inspir√© le nom du premier mouton clon√© (Dolly) ?", r: "Dolly Parton" },
        { q: "Quel est le fleuve qui traverse Paris ?", r: "La Seine" },
        { q: "Combien de couleurs dans un sachet de M&Ms ?", r: "Six" },
        { q: "Quel pays a offert la statue de la Libert√© aux USA ?", r: "La France" },
        { q: "Quelle boisson alcoolis√©e est fabriqu√©e √† partir de baies de gen√©vrier ?", r: "Le gin" },
        { q: "O√π se trouve le plus petit os du corps humain ?", r: "L'oreille" },
        { q: "Quelle est la capitale du Canada ?", r: "Ottawa" },
        { q: "Qui a √©crit Les aventures de Sherlock Holmes ?", r: "Arthur Conan Doyle" },
        { q: "Quel animal sur le logo de Porsche ?", r: "Le cheval" },
        { q: "En quelle ann√©e le Titanic a-t-il coul√© ?", r: "1912" },
        { q: "Quelle est la plus grande √Æle de la M√©diterran√©e ?", r: "La Sicile" },
        { q: "Dans quel bar de NY s'est d√©roul√© un soul√®vement LGBTQ+ en 1969 ?", r: "Le Stonewall Inn" },
        { q: "Quel est le nom de l'h√¥tel poss√©d√© dans 'The Shining' ?", r: "L'h√¥tel Overlook" },
        { q: "Plus longue fronti√®re internationale commune ?", r: "Canada / USA" },
        { q: "Quelle ville a accueilli les JO d'hiver 2014 ?", r: "Sotchi" },
        { q: "Quelle est la plus longue cha√Æne de montagnes terrestre ?", r: "Les Andes" },
        { q: "Quelle est la capitale de l'Iowa ?", r: "Des Moines" },
        { q: "Quelle est la langue la plus parl√©e au Br√©sil ?", r: "Le portugais" },
        { q: "Combien de femmes Henry VIII a-t-il eues ?", r: "Six" },
        { q: "Quel est le groupe sanguin le plus rare ?", r: "AB n√©gatif" },
        { q: "L'aubergine est un fruit ou un l√©gume ?", r: "Un fruit" },
        { q: "La Zone 51 est situ√©e dans quel √©tat ?", r: "Le Nevada" },
        { q: "Quel est le slogan d'Apple Inc ?", r: "Think Different" }
    ];

    const DATA = {
        pays: ["France", "USA", "Japon", "Italie", "Br√©sil", "Allemagne", "Russie", "Espagne", "Canada", "Mexique"],
        categories: ["Bi√®re", "Luxe", "Pr√©noms de merde", "Rappeurs rat√©s", "Jeux vid√©o", "S√©ries", "Horreur", "Fromages"],
        adjectifs: ["le plus radin", "celui qui parle trop fort", "le plus gros lourd", "le plus de mauvaise foi", "le plus susceptible de finir en zonzon"],
        lettres: ["A", "B", "C", "D", "E", "F", "G", "H", "L", "M", "N", "P", "R", "S", "T"],
        insultes: ["connard", "fils de pute", "encul√©", "pd", "salope", "chien", "chienne", "ordure", "d√©chet", "sous-merde", "trou du cul"]
    };

    const symbols = ['üê∑', 'üêó', 'üç∫', 'üíÄ'];
    let reactionStartTime = 0, reactionTimeout = null, lastGageTitle = "", isReactionActive = false;
    const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const insult = () => rand(DATA.insultes);
    
    // --- GAGES JOHN PORK (VULGAIRES) ---
    const DOUBLES_TEMPLATE = () => [
        { id: "REACTION", t: "REFLEXE DE CHIEN", d: `Clique sur ce gros lard de porc d√®s qu'il pointe son groin ! Si t'es plus lent que 0.65s, tu t'enfiles 1 gorg√©e pour ta lenteur de ${insult()}.` },
        { t: "LE SAVANT RAT√â", d: `√ânum√®re 5 villes de cette d√©charge qu'est : ${rand(DATA.pays)} sans b√©gayer comme un attard√©, sinon tu bois 1 gorg√©e pour fermer ta gueule de ${insult()}.` },
        { t: "L'ALPHABET POUR D√âBILE", d: `Trouve 3 √©l√©ments de la cat√©gorie "${rand(DATA.categories)}" qui commencent par la lettre ${rand(DATA.lettres)}. Si tu bloques, tu bois 1 gorg√©e pour rincer ton petit cerveau de ${insult()}.` },
        { t: "SANT√â SOLO", d: `T'as une sale gueule. John Pork r√©clame son tribut : Bois 2 gorg√©es imm√©diatement et ferme-la, esp√®ce d'${insult()}.` },
        { id: "FLASH", t: "FLASH INFO POUR D√âFICIENT", d: `R√©ponds correctement √† cette question ou bois une gorg√©e pour oublier ta stupidit√© de ${insult()}.` },
        { t: "CIN√âMA DE MERDE", d: `Cite 3 films d'un m√™me r√©alisateur avant que je m'√©nerve, sinon bois une gorg√©e pour ta culture de ${insult()}.` },
        { t: "GASTRONOMIE POUR RAT", d: `Cite 3 types de fromages diff√©rents, sinon bois 2 gorg√©es, esp√®ce de ${insult()} sans palais.` },
        { t: "TOP 3 DE LA HONTE", d: `Cite tes 3 pires ${rand(["exs", "souvenirs de baise", "plans foireux"])}. Si le groupe juge que c'est naze, tu bois 2 gorg√©es, sale ${insult()}.` },
        { t: "IMITATION MINABLE", d: `Imite une star de ton choix ; si personne ne devine en 20s tellement t'es nul, tu bois 1 gorg√©e pour la g√™ne, ${insult()}.` },
        { t: "VOTE POUR L'ORDURE", d: `Vote collectif : Qui est ${rand(DATA.adjectifs)} dans cette bande de rat√©s ? Le plus d√©sign√© boit 4 gorg√©es pour sa face de ${insult()}.` },
        { t: "LA CIBLE", d: `D√©signe un autre ${insult()} dans cette pi√®ce qui doit s'enfiler 2 gorg√©es imm√©diatement.` },
        { t: "LE DUEL", d: `Chifoumi contre ton voisin. Le perdant boit 2 gorg√©es et baisse les yeux, ${insult()}.` },
        { t: "FINGERS", d: `Posez tous un doigt sur la table. Le dernier ${insult()} √† s'ex√©cuter boit 2 gorg√©es.` },
        { t: "LA CHA√éNE", d: `Th√©matique : ${rand(DATA.categories)}. √ânum√©rez √† la cha√Æne. Le premier qui s√®che boit 3 gorg√©es, sale ${insult()}.` },
        { t: "DUEL DE REGARD", d: `Contre ton voisin. Le premier qui rigole comme une ${rand(["salope", "chienne"])} ou qui cligne boit 3 gorg√©es.` },
        { t: "RIZZ DE CHIOTTE", d: `Drague ton voisin de gauche avec une phrase bien grasse. Si c'est pas convaincant, bois 1 gorg√©e pour ton manque de charisme de ${insult()}.` },
        { t: "LE COMPTE", d: `Comptez jusqu'√† 20 chacun votre tour. Si deux glands parlent en m√™me temps, tout le monde boit 2 et on recommence, ${insult()} !` },
        { t: "LES JUMEAUX", d: `D√©signe deux victimes qui boiront ensemble pendant 3 tours. Choisissez bien, les ${insult()}s.` },
        { t: "CONNARD !", d: `Sors une phrase que dirait le pire des ${insult()}s. Si c'est trop light, tu bois 2 gorg√©es, petite nature.` }
    ];

    const TRIPLES_TEMPLATE = () => [
        { id: "PMU", t: "BACKROOM PMU", d: `Choisissez tous un canasson de merde. Les vainqueurs forcent les perdants √† s'enfiler 5 gorg√©es, ${insult()}s.` },
        { t: "CUL-SEC PARTIEL", d: `John Pork t'ordonne de vider la moiti√© de ton verre tout de suite. Ne discute pas, ${insult()}.` },
        { t: "LE PACTE DU DIABLE", d: `Bois 2 gorg√©es maintenant ou parie sur le prochain spin. Si le spin est perdant, tu finis ton putain de verre, ${insult()}.` },
        { t: "DOUBLE DOSE", d: `T'es marqu√© au fer rouge, mon gros. Tes 2 prochaines punitions sont doubl√©es, ${insult()}.` },
        { t: "LE CHOIX DE SOPHIE", d: `Soit tu bois 5 gorg√©es, soit tu montres ta derni√®re photo de t√©l√©phone √† ton voisin. Assume ta vie de ${insult()}.` },
        { t: "LE DICTATEUR", d: `D√©signe deux esclaves qui doivent boire 5 gorg√©es chacun. C'est toi l'${insult()} en chef.` },
        { t: "D√âCRET ROYAL", d: `Installe une r√®gle stupide. Chaque faute constat√©e = 1 gorg√©e pour l'${insult()} concern√©.` },
        { t: "L'ENCH√àRE", d: `Lance une ench√®re de gorg√©es. Celui qui accepte de boire le plus sauve les autres, mais boit son annonce de ${insult()}.` },
        { t: "LA CASCADE", d: `Waterfall ! Tout le monde boit en m√™me temps. Personne ne s'arr√™te tant que son voisin n'a pas fini, ${insult()}s !` },
        { t: "LE CAGEOT", d: `D√©signe le moins styl√© de la bande. Il doit s√©duire un objet pendant 1 min ou s'enfiler 6 gorg√©es, sale ${insult()}.` },
        { t: "TRIBUNAL", d: `Le groupe vote pour le plus gros ${insult()} qui doit boire 6 gorg√©es.` },
        { t: "ESPRIT D'√âQUIPE", d: `Tout le monde finit son verre sauf toi. Regarde-les souffrir, sale ${insult()}.` },
        { t: "CHOIX DE PORK", d: `Soit tu bois 8 gorg√©es comme un homme, soit tout le monde boit 2 comme des ${insult()}s.` }
    ];

    function toggleDebug() { document.getElementById('debug-panel').classList.toggle('open'); if (document.getElementById('debug-panel').classList.contains('open')) populateDebugMenu(); }

    function populateDebugMenu() {
        const content = document.getElementById('debug-content'); content.innerHTML = '';
        const sections = [{ title: "JACKPOT", list: [{ t: "BNZ JACKPOT", id: "BNZ" }] }, { title: "DOUBLES", list: DOUBLES_TEMPLATE() }, { title: "TRIPLES", list: TRIPLES_TEMPLATE() }];
        sections.forEach(section => {
            const title = document.createElement('div'); title.style = "color:var(--gold); border-bottom:1px solid #333; margin-top:10px; font-weight:bold;";
            title.innerText = section.title; content.appendChild(title);
            section.list.forEach(gage => {
                const btn = document.createElement('div'); btn.style = "background:#111; color:#eee; border:1px solid #222; padding:5px; margin-top:3px; cursor:pointer; font-size:0.7rem;";
                btn.innerText = gage.t; btn.onclick = () => { toggleDebug(); showGageModal(gage, section.title === "JACKPOT" ? "BNZ" : (section.title === "DOUBLES" ? "DOUBLE" : "TRIPLE")); };
                content.appendChild(btn);
            });
        });
    }

    function startReactionGame() {
        const game = document.getElementById('reaction-game'), target = document.getElementById('target-pig'), msg = document.getElementById('reaction-message');
        game.style.display = 'block'; target.style.display = 'none'; msg.innerText = "Ne bouge pas...";
        isReactionActive = true; reactionStartTime = 0;
        const delay = Math.random() * 4000 + 2000;
        reactionTimeout = setTimeout(() => {
            if(!isReactionActive) return;
            msg.innerText = "CLIQUE !"; target.style.display = 'block';
            target.style.top = Math.random() * 120 + 20 + 'px'; target.style.left = Math.random() * 70 + 5 + '%';
            reactionStartTime = Date.now();
        }, delay);
    }

    function handleReactionClick() {
        if (!isReactionActive) return;
        const msg = document.getElementById('reaction-message'), extra = document.getElementById('gage-extra');
        if (reactionStartTime === 0) {
            clearTimeout(reactionTimeout); msg.innerText = "TROP T√îT !";
            extra.innerHTML = `<p style='color:red; font-weight:bold;'>T'es trop press√©, sale ${insult()}. BOIS 2.</p>`;
        } else {
            const diff = (Date.now() - reactionStartTime) / 1000;
            document.getElementById('target-pig').style.display = 'none';
            if (diff <= 0.65) { msg.innerText = "OK."; extra.innerHTML = `<p style='color:green; font-weight:bold;'>Temps : ${diff}s. Pas mal pour un d√©chet. Distribue 1.</p>`; }
            else { msg.innerText = "TROP LENT."; extra.innerHTML = `<p style='color:red; font-weight:bold;'>Temps : ${diff}s. Path√©tique, ${insult()}. BOIS 1.</p>`; }
        }
        isReactionActive = false; document.getElementById('close-modal-btn').style.display = 'block';
    }

    async function runPMU() {
        document.getElementById('start-pmu-btn').style.display = 'none';
        const horses = [document.getElementById('h1'), document.getElementById('h2'), document.getElementById('h3'), document.getElementById('h4')];
        let positions = [0, 0, 0, 0], winner = -1;
        while(winner === -1) {
            for(let i=0; i<4; i++) {
                positions[i] += Math.random() * 2.0; 
                if (Math.random() > 0.9) positions[i] -= 0.8;
                horses[i].style.left = Math.max(0, positions[i]) + '%';
                if(positions[i] >= 88) winner = i + 1;
            }
            await new Promise(r => setTimeout(r, 150));
        }
        const colors = ["ROUGE", "BLEU", "JAUNE", "ROSE"];
        document.getElementById('gage-extra').innerHTML = `<p style='font-size:1.2rem; color:#8b0000; font-weight:bold; border:2px solid #000; padding:10px;'>VICTOIRE DU CHEVAL ${colors[winner-1]} !</p>`;
        document.getElementById('close-modal-btn').style.display = 'block';
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, d, type = 'square') {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.value = f;
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    function initGame() { 
        document.getElementById('setup-screen').style.display = 'none'; 
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
        beep(400, 0.2); 
        // Initialisation des rouleaux
        [0,1,2].forEach(id => {
            const track = document.getElementById('r'+id);
            track.innerHTML = `<div class="symbol">üé∞</div>`;
        });
    }

    async function play() {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        document.getElementById('spin-btn').disabled = true; beep(200, 0.1);
        const luck = Math.random();
        let res = [], combo = "";
        if(luck < 0.04) { res = ['B', 'N', 'Z']; combo = "BNZ"; } 
        else if(luck < 0.15) { const s = symbols[Math.floor(Math.random()*4)]; res = [s, s, s]; combo = "TRIPLE"; } 
        else if(luck < 0.50) { const s = symbols[Math.floor(Math.random()*4)]; let s2; do { s2 = symbols[Math.floor(Math.random()*4)]; } while(s2 === s); res = [s, s, s2].sort(() => Math.random() - 0.5); combo = "DOUBLE"; } 
        else { let s1, s2, s3; do { s1 = Math.random() > 0.8 ? 'B' : symbols[Math.floor(Math.random()*4)]; s2 = Math.random() > 0.8 ? 'N' : symbols[Math.floor(Math.random()*4)]; s3 = Math.random() > 0.8 ? 'Z' : symbols[Math.floor(Math.random()*4)]; } while (s1 === s2 || s2 === s3 || s1 === s3 || (s1==='B' && s2==='N' && s3==='Z')); res = [s1, s2, s3]; }
        const anims = [0,1,2].map(id => animateReel(id, res[id]));
        await Promise.all(anims);
        setTimeout(() => {
            if(combo !== "") {
                let gage;
                const pool = (combo === "BNZ") ? [{ t: "JACKPOT BNZ", d: `VOS GUEULES ! Votre √©quipe d'encul√©s gagne 25 JETONS IRL. Rangez √ßa avant que je vous pisse dessus, sale bande de ${insult()}s.` }] : (combo === "DOUBLE" ? DOUBLES_TEMPLATE() : TRIPLES_TEMPLATE());
                do { gage = rand(pool); } while (gage.t === lastGageTitle && pool.length > 1);
                lastGageTitle = gage.t;
                showGageModal(gage, combo);
            } else { document.getElementById('spin-btn').disabled = false; }
        }, 500);
    }

    function animateReel(id, target) {
        return new Promise(resolve => {
            const track = document.getElementById('r'+id), count = 25 + (id * 7);
            const content = [];
            for(let i=0; i<count; i++) {
                const s = (i === count - 1) ? target : symbols[Math.floor(Math.random() * 4)];
                content.push(`<div class="symbol ${['B','N','Z'].includes(s) ? 'sym-'+s : ''}">${s}</div>`);
            }
            // Injection sans vidage pour iPad
            track.innerHTML = content.join('');
            track.style.transition = 'none'; 
            track.style.transform = 'translateY(0)'; 
            track.offsetHeight;
            track.style.transition = `transform ${1.8 + id*0.5}s cubic-bezier(0.1, 0, 0, 1)`;
            track.style.transform = `translateY(-${(count-1)*140}px)`;
            setTimeout(() => { beep(200 + (id*100), 0.15, 'triangle'); resolve(); }, 1800 + id*500);
        });
    }

    async function showGageModal(gage, combo) {
        document.getElementById('gage-title').innerText = combo + " : " + gage.t;
        document.getElementById('gage-desc').innerText = gage.d;
        document.getElementById('gage-extra').innerHTML = "";
        document.getElementById('reaction-game').style.display = 'none';
        document.getElementById('pmu-game').style.display = 'none';
        document.getElementById('close-modal-btn').style.display = 'none';
        document.getElementById('pork-body').style.display = 'none';
        document.getElementById('pork-timer').style.display = 'block';
        document.getElementById('pork-modal').style.display = 'flex';
        for(let i=3; i>0; i--) { document.getElementById('pork-timer').innerText = i; beep(400, 0.1, 'square'); await new Promise(r => setTimeout(r, 700)); }
        document.getElementById('pork-timer').style.display = 'none';
        document.getElementById('pork-body').style.display = 'block';
        beep(150, 0.4, 'sawtooth');
        if(gage.id === "FLASH") {
            const q = rand(QUESTIONS); document.getElementById('gage-desc').innerText = q.q;
            document.getElementById('gage-extra').innerHTML = `<button class="btn-action" onclick="this.innerText='${q.r.replace(/'/g, "\\'")}'">D√âVOILER LA R√âPONSE</button>`;
            document.getElementById('close-modal-btn').style.display = 'block';
        } else if(gage.id === "REACTION") { startReactionGame(); }
        else if(gage.id === "PMU") { 
            document.getElementById('pmu-game').style.display = 'block';
            document.getElementById('start-pmu-btn').style.display = 'block';
            [1,2,3,4].forEach(i => document.getElementById('h'+i).style.left = '0%');
        } else { document.getElementById('close-modal-btn').style.display = 'block'; }
    }

    function closePork() { isReactionActive = false; document.getElementById('pork-modal').style.display = 'none'; document.getElementById('spin-btn').disabled = false; beep(600, 0.1); }
</script>
</body>
</html>
